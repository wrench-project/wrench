language: cpp

sudo: required

addons:
sonarcloud:
  organization: "wrench"
  token:
    secure: "a3gk/Phr7yPccMhzBp6LRwEkIXWwSMbeC20sm0N5O/eZ63gN+4sp371pQcUugoPIXBa1jLMeJLL0we950EY9/kFPMVTdscHJ1OOwrM98R65dTtayxLOhDf1D8GTnrOIdpuH9vMatIulRoW0TYUhD1Ay2wIJWToXAJRM4W3bgzAOfsaM45PYeR21tlIuplazZtNys7XFVBO/4F4dHvG1tC5DqiaAM6GBHWqFivdr6vOVzZRZ1+ZvNWv0qk0zy4uxF6W4C+kdBEqhX6Ad2/AuFxIEe5zwdgqMGIu3pSySLVmcrIAGUjBqkR84iQQjlbniSEUyv89jpTvyJ9D95UVlbJ9PB38SYLtfyboDgXb2Sm/M3v0gqPcF6ZX8RP9MaIBEN6HfB4XpPYN4CI6Pwkzkz+7gdFPIl6o5lqbjrvXkeccBH2pWIHrL33pBkIB/wQEKA552jZbB9DbU+A2lobJcFREO5PO5EPWh2WUFB9/C0cOTHPY2k8W92mvsjXlWNqmUTqKwQsldOLrX45sPTkFFCAMU0hOVrjL4qtVO8l/jJitRvtKqXe3ZK1dbZmJU1Rh2G7KDS6+m4t2kIgoxtYDOPdHft38s6NTo/639TPEisn2kLO4sjx/sk2KXh7ja6vKa/eNKMxUBLTbv0x28xMiKN/WEtSTzQKsLWpYLlMUNGUTM="

env:
  - DIST=ubuntu-trusty GCC_VERSION=5

services:
  - docker

before_install:
  - docker pull wrenchproject/wrench-build:${DIST}-gcc${GCC_VERSION}
  - docker run -d -t --name=wrench wrenchproject/wrench-build:${DIST}-gcc${GCC_VERSION} bash
  - docker cp . wrench:/home/wrench
  - docker exec -it wrench mkdir build

script:
  - docker exec -w /home/wrench/build -it wrench cmake -DCMAKE_VERBOSE_MAKEFILE=ON ..
  - docker exec -it wrench ls -lh build
  - docker exec -w /home/wrench/build -it wrench make all unit_tests doc-gh
  - docker exec -w /home/wrench/build -it wrench ./unit_tests

after_success:
  - docker stop wrench
  - docker rm wrench
  - docker rmi wrenchproject/wrench-build:${DIST}-gcc${GCC_VERSION}
  # coverage analysis
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      lcov --directory . --capture --output-file coverage.info;
      lcov --remove coverage.info '*/test/*' '*/examples/*' '*/include/*' --output-file coverage.info;
      coveralls-lcov --repo-token ${COVERALLS_TOKEN} coverage.info;
    fi
  # sonarcloud
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      build-wrapper-linux-x86-64 --out-dir bw-output make all;
      sonar-scanner -Dsonar.host.url=https://sonarqube.com -Dsonar.login=$SONAR_TOKEN;
    fi

#deploy:
#  provider: pages
#  skip_cleanup: true
#  github_token: $GITHUB_TOKEN
#  local_dir: ./docs/gh-pages
#  on:
#    branch: master

notifications:
  email:
    recipients:
      - wrench@mailman.isi.edu
    on_success: change
    on_failure: change
#    on_failure: always
